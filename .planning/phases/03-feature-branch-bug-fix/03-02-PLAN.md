---
phase: 03-feature-branch-bug-fix
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/Schema/SchemaValidator.php
  - src/Schema/OntologyInspector.php
  - tests/phpunit/unit/Schema/SchemaValidatorTest.php
autonomous: true

must_haves:
  truths:
    - "SchemaValidator warns (not errors) when property appears in both required and optional"
    - "SchemaValidator warns (not errors) when subobject appears in both required and optional"
    - "Promotion warnings are visible on Special:SemanticSchemas validate tab"
    - "Existing schemas without conflicts produce no new warnings"
  artifacts:
    - path: "src/Schema/SchemaValidator.php"
      provides: "Warning instead of error for required/optional overlap"
      contains: "promoted to required"
    - path: "src/Schema/OntologyInspector.php"
      provides: "Uses validateSchemaWithSeverity to surface promotion warnings"
      contains: "validateSchemaWithSeverity"
    - path: "tests/phpunit/unit/Schema/SchemaValidatorTest.php"
      provides: "Tests for warning-not-error behavior"
      contains: "testDuplicateRequiredOptionalPropertyEmitsWarningNotError"
  key_links:
    - from: "src/Schema/OntologyInspector.php"
      to: "src/Schema/SchemaValidator.php"
      via: "validateSchemaWithSeverity() call replacing validateSchema()"
      pattern: "validateSchemaWithSeverity"
    - from: "src/Schema/SchemaValidator.php"
      to: "formatWarning"
      via: "Warning emitted via formatWarning helper"
      pattern: "formatWarning.*promoted to required"
---

<objective>
Change SchemaValidator from error to warning for required/optional overlaps, and update OntologyInspector to surface these warnings on the validate tab.

Purpose: The validator currently produces an error when a property or subobject appears in both required and optional lists. Since the models now silently promote (Plan 01), the validator should warn (not block) to inform users while allowing import to proceed. The OntologyInspector must be updated to use `validateSchemaWithSeverity()` so these warnings actually appear on the Special:SemanticSchemas validate tab.

Output: SchemaValidator emits warnings for overlaps. OntologyInspector surfaces all warnings. Tests updated.
</objective>

<execution_context>
@/home/daharoni/.claude/get-shit-done/workflows/execute-plan.md
@/home/daharoni/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-feature-branch-bug-fix/03-CONTEXT.md
@.planning/phases/03-feature-branch-bug-fix/03-RESEARCH.md
@src/Schema/SchemaValidator.php
@src/Schema/OntologyInspector.php
@tests/phpunit/unit/Schema/SchemaValidatorTest.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Change SchemaValidator overlap from error to warning</name>
  <files>
    src/Schema/SchemaValidator.php
    src/Schema/OntologyInspector.php
  </files>
  <action>
1. In `src/Schema/SchemaValidator.php`, method `validateRequiredOptionalBuckets()` (lines 302-314):

   Replace the error emission with a warning. Change from:
   ```php
   if ( !empty( $duplicates ) ) {
       $itemType = ucfirst( $referenceType ) . 's';
       $errors[] = $this->formatError(
           $entityType,
           $entityName,
           "$itemType cannot be both required and optional: " . implode( ', ', $duplicates ),
           'Remove duplicates from either list'
       );
   }
   ```

   To:
   ```php
   if ( !empty( $duplicates ) ) {
       $itemType = ucfirst( $referenceType ) . 's';
       $warnings[] = $this->formatWarning(
           $entityType,
           $entityName,
           "$itemType listed as both required and optional will be promoted to required: "
           . implode( ', ', $duplicates )
       );
   }
   ```

   This uses the existing `formatWarning()` helper (line 184) which produces the format: `Category 'Name': issue description`. The `$warnings` array is already declared at line 283 and returned at line 322.

2. In `src/Schema/OntologyInspector.php`, method `validateWikiState()` (lines 145-223):

   Replace lines 149-150:
   ```php
   $errors = $validator->validateSchema( $schema );
   $warnings = $validator->generateWarnings( $schema );
   ```

   With:
   ```php
   $validationResult = $validator->validateSchemaWithSeverity( $schema );
   $errors = $validationResult['errors'];
   $warnings = $validationResult['warnings'];
   ```

   This is important because `validateSchema()` only returns errors (discards warnings from `validateSchemaWithSeverity()`). The new promotion warnings would never appear on the validate tab without this change.

   NOTE: `validateSchemaWithSeverity()` already calls `generateWarnings()` internally (line 92 of SchemaValidator.php), so we do NOT need a separate `generateWarnings()` call. Removing it avoids double-counting warnings.

IMPORTANT: Do NOT touch `generateWarnings()` method. It does not check for required/optional overlap (it checks for empty properties, missing display config, unused properties). There is no risk of double-warning.
  </action>
  <verify>
    Run `composer test` -- should pass. The SchemaValidatorTest `testSubobjectWithDuplicatePropertyListsReturnsError` will now FAIL because the overlap is now a warning not an error. This is expected and will be fixed in Task 2.

    Quick sanity check: `grep -n 'formatWarning' src/Schema/SchemaValidator.php` should show the new usage in `validateRequiredOptionalBuckets()`.
  </verify>
  <done>
    SchemaValidator emits warning (not error) for required/optional overlaps. OntologyInspector uses `validateSchemaWithSeverity()` to surface all warnings including promotion warnings on the validate tab.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update SchemaValidator tests for warning behavior</name>
  <files>tests/phpunit/unit/Schema/SchemaValidatorTest.php</files>
  <action>
1. In `tests/phpunit/unit/Schema/SchemaValidatorTest.php`:

   a. Replace `testSubobjectWithDuplicatePropertyListsReturnsError` with `testSubobjectWithDuplicatePropertyListsReturnsWarningNotError`:
   ```php
   public function testSubobjectWithDuplicatePropertyListsReturnsWarningNotError(): void {
       $schema = $this->getValidSchema();
       $schema['subobjects'] = [
           'TestSubobject' => [
               'properties' => [
                   'required' => [ 'Has name' ],
                   'optional' => [ 'Has name' ],
               ],
           ],
       ];

       $result = $this->validator->validateSchemaWithSeverity( $schema );
       $this->assertEmpty( $result['errors'], 'Overlap should not produce errors' );

       $hasPromotionWarning = false;
       foreach ( $result['warnings'] as $warning ) {
           if ( stripos( $warning, 'promoted to required' ) !== false ) {
               $hasPromotionWarning = true;
               break;
           }
       }
       $this->assertTrue( $hasPromotionWarning, 'Should warn about promotion to required' );
   }
   ```

   b. Add `testCategoryDuplicateRequiredOptionalPropertyReturnsWarningNotError`:
   ```php
   public function testCategoryDuplicateRequiredOptionalPropertyReturnsWarningNotError(): void {
       $schema = $this->getValidSchema();
       $schema['categories']['TestCategory']['properties'] = [
           'required' => [ 'Has name' ],
           'optional' => [ 'Has name', 'Has description' ],
       ];

       $result = $this->validator->validateSchemaWithSeverity( $schema );
       $this->assertEmpty( $result['errors'], 'Overlap should not produce errors' );

       $hasPromotionWarning = false;
       foreach ( $result['warnings'] as $warning ) {
           if ( stripos( $warning, 'promoted to required' ) !== false ) {
               $hasPromotionWarning = true;
               break;
           }
       }
       $this->assertTrue( $hasPromotionWarning, 'Should warn about promotion to required' );
   }
   ```

   c. Add `testCategoryDuplicateRequiredOptionalSubobjectReturnsWarningNotError`:
   ```php
   public function testCategoryDuplicateRequiredOptionalSubobjectReturnsWarningNotError(): void {
       $schema = $this->getValidSchema();
       $schema['subobjects'] = [
           'Author' => [
               'properties' => [
                   'required' => [ 'Has name' ],
                   'optional' => [],
               ],
           ],
           'Funding' => [
               'properties' => [
                   'required' => [ 'Has name' ],
                   'optional' => [],
               ],
           ],
       ];
       $schema['categories']['TestCategory']['subobjects'] = [
           'required' => [ 'Author' ],
           'optional' => [ 'Author', 'Funding' ],
       ];

       $result = $this->validator->validateSchemaWithSeverity( $schema );
       $this->assertEmpty( $result['errors'], 'Subobject overlap should not produce errors' );

       $hasPromotionWarning = false;
       foreach ( $result['warnings'] as $warning ) {
           if ( stripos( $warning, 'promoted to required' ) !== false ) {
               $hasPromotionWarning = true;
               break;
           }
       }
       $this->assertTrue( $hasPromotionWarning, 'Should warn about subobject promotion' );
   }
   ```

   d. Add `testNoOverlapProducesNoPromotionWarning`:
   ```php
   public function testNoOverlapProducesNoPromotionWarning(): void {
       $schema = $this->getValidSchema();

       $result = $this->validator->validateSchemaWithSeverity( $schema );
       foreach ( $result['warnings'] as $warning ) {
           $this->assertStringNotContainsString(
               'promoted to required',
               $warning,
               'No promotion warning should appear when there are no overlaps'
           );
       }
   }
   ```

   e. Add `testValidateSchemaErrorsOnlyMethodExcludesWarnings` to verify the `validateSchema()` wrapper still returns only errors:
   ```php
   public function testValidateSchemaErrorsOnlyMethodExcludesWarnings(): void {
       $schema = $this->getValidSchema();
       $schema['categories']['TestCategory']['properties'] = [
           'required' => [ 'Has name' ],
           'optional' => [ 'Has name', 'Has description' ],
       ];

       $errors = $this->validator->validateSchema( $schema );
       foreach ( $errors as $error ) {
           $this->assertStringNotContainsString(
               'promoted to required',
               $error,
               'validateSchema() should not return promotion warnings as errors'
           );
       }
   }
   ```
  </action>
  <verify>
    Run `php vendor/bin/phpunit tests/phpunit/unit/Schema/SchemaValidatorTest.php` -- ALL tests pass (0 failures, 0 errors).
    Then run full `composer test` -- everything green.
  </verify>
  <done>
    SchemaValidatorTest has warning-based tests replacing the old error test. New tests verify: category property overlap warns, category subobject overlap warns, subobject property overlap warns, no-overlap produces no promotion warning, validateSchema() excludes warnings. Full test suite is green.
  </done>
</task>

</tasks>

<verification>
1. `composer test` passes with 0 failures
2. `php vendor/bin/phpunit tests/phpunit/unit/Schema/` runs all Schema tests green
3. `grep -c 'promoted to required' src/Schema/SchemaValidator.php` returns 1 (one warning emission point)
4. `grep -c 'validateSchemaWithSeverity' src/Schema/OntologyInspector.php` returns 1 (new method call)
5. `grep -c 'formatError.*both required and optional' src/Schema/SchemaValidator.php` returns 0 (old error removed)
6. No test in SchemaValidatorTest asserts error for required/optional overlap
</verification>

<success_criteria>
- SchemaValidator emits warning (not error) for required/optional overlap in properties
- SchemaValidator emits warning (not error) for required/optional overlap in subobjects
- Warning message contains "promoted to required" (informative, matches formatWarning pattern)
- OntologyInspector uses validateSchemaWithSeverity() so warnings appear on validate tab
- No double-warnings (generateWarnings does not duplicate the promotion warning)
- validateSchema() (errors-only wrapper) does not return promotion messages as errors
- Existing valid schemas produce no new warnings
- `composer test` fully green
</success_criteria>

<output>
After completion, create `.planning/phases/03-feature-branch-bug-fix/03-02-SUMMARY.md`
</output>
