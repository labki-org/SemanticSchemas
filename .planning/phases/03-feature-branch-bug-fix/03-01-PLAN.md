---
phase: 03-feature-branch-bug-fix
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/Schema/CategoryModel.php
  - src/Schema/SubobjectModel.php
  - tests/phpunit/unit/Schema/CategoryModelTest.php
  - tests/phpunit/unit/Schema/SubobjectModelTest.php
autonomous: true

must_haves:
  truths:
    - "CategoryModel constructor silently promotes overlapping properties to required instead of throwing"
    - "CategoryModel constructor silently promotes overlapping subobjects to required instead of throwing"
    - "SubobjectModel constructor silently promotes overlapping properties to required instead of throwing"
    - "Existing schemas without conflicts continue working identically"
  artifacts:
    - path: "src/Schema/CategoryModel.php"
      provides: "Silent promotion of overlapping properties and subobjects in constructor"
      contains: "array_diff.*optionalProperties.*requiredProperties"
    - path: "src/Schema/SubobjectModel.php"
      provides: "Silent promotion of overlapping properties in constructor"
      contains: "array_diff.*optionalProperties.*requiredProperties"
    - path: "tests/phpunit/unit/Schema/CategoryModelTest.php"
      provides: "Tests for promotion behavior replacing exception tests"
      contains: "testDuplicateRequiredOptionalPropertyPromotesToRequired"
    - path: "tests/phpunit/unit/Schema/SubobjectModelTest.php"
      provides: "Tests for SubobjectModel promotion behavior"
      contains: "testDuplicateRequiredOptionalPropertyPromotesToRequired"
  key_links:
    - from: "src/Schema/CategoryModel.php"
      to: "CategoryModel::mergeWithParent()"
      via: "Same array_diff pattern used in both constructor and merge"
      pattern: "array_diff.*optional.*required"
---

<objective>
Create the `multi-category-page-creation` feature branch and fix the three constructor crash points where CategoryModel and SubobjectModel throw InvalidArgumentException when a property or subobject appears in both the required and optional arrays.

Purpose: This is a crash fix. The current code throws on required/optional overlaps that legitimately occur during inheritance resolution. The fix silently promotes overlapping items to required (removing them from optional), matching the existing pattern in `mergeWithParent()`.

Output: Feature branch created from main. Three constructor crash points replaced with silent promotion. All existing tests pass plus new promotion tests.
</objective>

<execution_context>
@/home/daharoni/.claude/get-shit-done/workflows/execute-plan.md
@/home/daharoni/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-feature-branch-bug-fix/03-CONTEXT.md
@.planning/phases/03-feature-branch-bug-fix/03-RESEARCH.md
@src/Schema/CategoryModel.php
@src/Schema/SubobjectModel.php
@tests/phpunit/unit/Schema/CategoryModelTest.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create feature branch and fix model constructors</name>
  <files>
    src/Schema/CategoryModel.php
    src/Schema/SubobjectModel.php
  </files>
  <action>
1. Create git branch `multi-category-page-creation` from current `main`:
   ```
   git checkout -b multi-category-page-creation
   ```

2. In `src/Schema/CategoryModel.php`, replace the property overlap throw (lines 120-126) with silent promotion:
   ```php
   // Replace the throw block with:
   $this->optionalProperties = array_values(
       array_diff( $this->optionalProperties, $this->requiredProperties )
   );
   ```
   This removes any property that appears in requiredProperties from optionalProperties.

3. In the same file, replace the subobject overlap throw (lines 138-144) with silent promotion:
   ```php
   // Replace the throw block with:
   $this->optionalSubobjects = array_values(
       array_diff( $this->optionalSubobjects, $this->requiredSubobjects )
   );
   ```

4. In `src/Schema/SubobjectModel.php`, replace the property overlap throw (lines 83-89) with silent promotion:
   ```php
   // Replace the throw block with:
   $this->optionalProperties = array_values(
       array_diff( $this->optionalProperties, $this->requiredProperties )
   );
   ```

IMPORTANT: Do NOT add any new methods or setters. The promotion happens in the constructor before the object is fully constructed, preserving the immutability contract. This pattern mirrors the existing `array_diff` in `CategoryModel::mergeWithParent()` at lines 255-261.

IMPORTANT: Keep the `array_values()` wrapper to re-index the array after `array_diff`, matching the existing `mergeWithParent()` pattern.
  </action>
  <verify>
    Run `composer test` -- all existing tests must pass except the two tests that assert exceptions for overlaps (those will be updated in Task 2). Specifically:
    - `testDuplicateRequiredOptionalPropertyThrowsException` will now FAIL (expected -- it expects a throw that no longer happens)
    - `testDuplicateRequiredOptionalSubobjectThrowsException` will now FAIL (expected -- same reason)
    - All other tests must PASS
  </verify>
  <done>
    Feature branch `multi-category-page-creation` exists. Three constructor crash points replaced with silent promotion. All tests pass except the two that explicitly assert the old throw behavior.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update and add unit tests for promotion behavior</name>
  <files>
    tests/phpunit/unit/Schema/CategoryModelTest.php
    tests/phpunit/unit/Schema/SubobjectModelTest.php
  </files>
  <action>
1. In `tests/phpunit/unit/Schema/CategoryModelTest.php`:

   a. Replace `testDuplicateRequiredOptionalPropertyThrowsException` with `testDuplicateRequiredOptionalPropertyPromotesToRequired`:
   ```php
   public function testDuplicateRequiredOptionalPropertyPromotesToRequired(): void {
       $model = new CategoryModel( 'TestCategory', [
           'properties' => [
               'required' => [ 'Has name' ],
               'optional' => [ 'Has name', 'Has email' ],
           ],
       ] );

       $this->assertContains( 'Has name', $model->getRequiredProperties() );
       $this->assertNotContains( 'Has name', $model->getOptionalProperties() );
       $this->assertContains( 'Has email', $model->getOptionalProperties() );
   }
   ```

   b. Replace `testDuplicateRequiredOptionalSubobjectThrowsException` with `testDuplicateRequiredOptionalSubobjectPromotesToRequired`:
   ```php
   public function testDuplicateRequiredOptionalSubobjectPromotesToRequired(): void {
       $model = new CategoryModel( 'TestCategory', [
           'subobjects' => [
               'required' => [ 'Author' ],
               'optional' => [ 'Author', 'Funding' ],
           ],
       ] );

       $this->assertContains( 'Author', $model->getRequiredSubobjects() );
       $this->assertNotContains( 'Author', $model->getOptionalSubobjects() );
       $this->assertContains( 'Funding', $model->getOptionalSubobjects() );
   }
   ```

   c. Add a test that verifies no conflict (baseline still works):
   ```php
   public function testNoConflictPropertiesUnchanged(): void {
       $model = new CategoryModel( 'TestCategory', [
           'properties' => [
               'required' => [ 'Has name' ],
               'optional' => [ 'Has email' ],
           ],
       ] );

       $this->assertEquals( [ 'Has name' ], $model->getRequiredProperties() );
       $this->assertEquals( [ 'Has email' ], $model->getOptionalProperties() );
   }
   ```

2. Create `tests/phpunit/unit/Schema/SubobjectModelTest.php` following the existing test patterns:
   - Namespace: `MediaWiki\Extension\SemanticSchemas\Tests\Unit\Schema`
   - Use `PHPUnit\Framework\TestCase`
   - `@covers \MediaWiki\Extension\SemanticSchemas\Schema\SubobjectModel`
   - Include these tests:
     - `testDuplicateRequiredOptionalPropertyPromotesToRequired` -- overlapping property promoted to required, removed from optional, other optionals preserved
     - `testNoConflictPropertiesUnchanged` -- non-overlapping required/optional arrays remain unchanged
     - `testEmptyNameThrowsException` -- empty name still throws
     - `testGetNameReturnsCorrectValue` -- basic accessor
     - `testGetAllPropertiesCombinesBoth` -- getAllProperties returns union
     - `testIsPropertyRequiredReturnsTrue` -- for required property
     - `testIsPropertyRequiredReturnsFalse` -- for optional property
     - `testToArrayContainsAllFields` -- export includes all expected keys
  </action>
  <verify>
    Run `php vendor/bin/phpunit tests/phpunit/unit/Schema/CategoryModelTest.php tests/phpunit/unit/Schema/SubobjectModelTest.php` -- ALL tests pass (0 failures, 0 errors).
    Then run full `composer test` -- everything green.
  </verify>
  <done>
    All CategoryModel tests pass including new promotion tests. SubobjectModel has a test file with promotion and baseline tests. Full test suite is green. No tests assert exception-on-overlap behavior.
  </done>
</task>

</tasks>

<verification>
1. `git branch --show-current` returns `multi-category-page-creation`
2. `composer test` passes with 0 failures
3. `php vendor/bin/phpunit tests/phpunit/unit/Schema/` runs all Schema tests green
4. Manual check: no `expectException.*InvalidArgumentException` in CategoryModelTest for the overlap cases
5. Manual check: SubobjectModelTest.php exists and has promotion test
</verification>

<success_criteria>
- Feature branch `multi-category-page-creation` created from main
- CategoryModel constructor promotes overlapping properties to required (no throw)
- CategoryModel constructor promotes overlapping subobjects to required (no throw)
- SubobjectModel constructor promotes overlapping properties to required (no throw)
- All existing tests updated and pass
- New SubobjectModelTest.php created with promotion tests
- `composer test` fully green
</success_criteria>

<output>
After completion, create `.planning/phases/03-feature-branch-bug-fix/03-01-SUMMARY.md`
</output>
