# Phase 4: Conditional Templates - Research

**Researched:** 2026-02-02
**Domain:** Semantic MediaWiki `#set` parser function, MediaWiki `#if` conditionals, TemplateGenerator wikitext output
**Confidence:** HIGH

## Summary

This phase modifies TemplateGenerator output to wrap each `#set` property assignment in `{{#if}}` guards, preventing empty values from being stored as SMW annotations. It also switches multi-value properties from inline `[[Property::Value]]` annotations (via `#arraymap`) to the `+sep` parameter within `#set`.

The codebase changes are narrow: the primary modification is to `generateSemanticTemplate()` and `generatePropertyLine()` in `src/Generator/TemplateGenerator.php`. The current code already uses `{{#if}}` for one special case (single-value Page-type properties with namespace prefixes), so the pattern is already established. The change generalizes this pattern to ALL properties. Subobject templates (`generateSubobjectTemplate()`) should also receive the same treatment.

**Primary recommendation:** Wrap every property line inside `#set` with `{{#if:{{{param|}}}|...|}}` and use `+sep=,` for multi-value properties. This is a pure output change with no architectural modifications needed.

## Standard Stack

No new libraries are needed. This phase modifies generated wikitext output only.

### Core (MediaWiki/SMW Parser Functions Used)
| Function | Purpose | Why Used |
|----------|---------|----------|
| `{{#set:}}` | Store semantic property values silently | Already used -- the core storage mechanism |
| `{{#if:}}` | Conditional evaluation of template parameters | Guards `#set` to prevent empty value storage |
| `+sep=` | Split delimited string into multiple SMW values | Replaces `#arraymap` inline annotations for multi-value |
| `{{{param\|}}}` | Template parameter with empty default | The correct pattern for `#if` emptiness checks |

### Not Needed (Remove)
| Current Pattern | Replacement | Why |
|-----------------|-------------|-----|
| `#arraymap` + inline `[[Property::Value]]` | `+sep=,` inside `#set` | `+sep` is simpler, stays within `#set` block, officially recommended since SMW 1.9.0 |

## Architecture Patterns

### Current Semantic Template Structure (BEFORE)

The current `generateSemanticTemplate()` produces:

```
<noinclude>
<!-- AUTO-GENERATED by SemanticSchemas - DO NOT EDIT MANUALLY -->
Semantic template for Category:Person
</noinclude><includeonly>
{{#set:
 | Has email = {{{email|}}}
 | Has full name = {{{full_name|}}}
}}

[[Category:Person]]
</includeonly>
```

For Page-type properties with namespace prefix (single-value), the current code already produces:

```
 | Has display pattern = {{#if:{{{display_pattern|}}}|Property:{{{display_pattern|}}}|}}
```

For multi-value Page-type properties with namespace prefix, the current code generates inline annotations OUTSIDE `#set`:

```
{{#arraymap:{{{optional_subgroup|}}}|,|@@item@@|[[Has optional subgroup::Subobject:@@item@@]]|}}
```

### Recommended Semantic Template Structure (AFTER)

```
<noinclude>
<!-- AUTO-GENERATED by SemanticSchemas - DO NOT EDIT MANUALLY -->
Semantic template for Category:Person
</noinclude><includeonly>
{{#set:
 | Has email = {{#if:{{{email|}}}|{{{email|}}}|}}
 | Has full name = {{#if:{{{full_name|}}}|{{{full_name|}}}|}}
}}

[[Category:Person]]
</includeonly>
```

For multi-value properties using `+sep`:

```
{{#set:
 | Has keywords = {{#if:{{{keywords|}}}|{{{keywords|}}}|}}|+sep=,
}}
```

For Page-type with namespace prefix (already conditional, just standardize pattern):

```
 | Has display pattern = {{#if:{{{display_pattern|}}}|Property:{{{display_pattern|}}}|}}
```

For multi-value Page-type with namespace prefix (replace `#arraymap` with `+sep` inside `#set`):

```
 | Has optional subgroup = {{#if:{{{optional_subgroup|}}}|{{{optional_subgroup|}}}|}}|+sep=,
```

Note: The namespace prefixing for multi-value Page properties with `allowedNamespace` needs special consideration. The `+sep` approach splits on comma and stores each as a separate value, but does not add a namespace prefix per-value the way `#arraymap` does. For these properties, `#arraymap` may need to be retained outside `#set` (wrapped in `#if`). See Open Questions section.

### Pattern: Per-Property `#if` Guard

Each property line gets its own `#if` guard. This is preferred over wrapping the entire `#set` block because:

1. A page may receive some parameters but not others (especially in multi-category scenarios where different templates provide different parameters)
2. Per-property guards allow partial data storage -- filled properties are stored, empty ones are skipped
3. The `#set` block itself is always present (even if all properties are empty, the `#set:` with no property lines is harmless)

### Pattern: `+sep` for Multi-Value Properties

The `+sep` parameter applies per-property within `#set`. Syntax:

```
{{#set:
 | PropertyA = value1,value2|+sep=,
 | PropertyB = single value
}}
```

Key behaviors (HIGH confidence, from SMW official docs):
- `+sep` is per-property, not global to the `#set` block
- Trailing separators create empty values -- the `#if` guard prevents this
- Leading/trailing spaces on outer values are trimmed by SMW
- Available since SMW 1.9.0 (current codebase already uses modern SMW)
- Works identically inside `#subobject:` blocks

### Pattern: Comma as Separator Character

Use comma (`,`) as the `+sep` separator because:
- PageForms `tokens` input type uses comma as its default delimiter
- The current `#arraymap` calls in the codebase already use comma as delimiter
- The DisplayStubGenerator `buildValueExpression()` already uses comma
- Consistent with PageForms ecosystem conventions

### File Modification Scope

Only these methods in `TemplateGenerator.php` need changes:

| Method | Change |
|--------|--------|
| `generatePropertyLine()` | Add `#if` guard to ALL property lines (currently only Page-type with namespace has `#if`); add `+sep=,` for multi-value |
| `generateSemanticTemplate()` | Handle multi-value properties with namespace prefix: either keep `#arraymap` with `#if` wrapper, or use `+sep` if namespace prefix is not needed |
| `generateSubobjectTemplate()` | Same `#if` guard pattern for subobject properties |
| `generateInlineAnnotation()` | May need `#if` wrapper if retained, or may be removed if `+sep` replaces all use cases |

### Anti-Patterns to Avoid

- **Wrapping entire `#set` in `#if`:** Don't do `{{#if:{{{any_param|}}}|{{#set:...}}|}}`. This is all-or-nothing and defeats the purpose.
- **Using `{{{param}}}` without trailing pipe in `#if`:** Without the pipe, undefined parameters produce literal `{{{param}}}` text which `#if` treats as truthy. Always use `{{{param|}}}`.
- **Storing empty values via `#set`:** SMW does not gracefully handle empty string values in `#set`. Known issues include potential breakage and unwanted annotations. The `#if` guard prevents this.
- **Using `|` (pipe) as multi-value separator:** Deprecated since SMW 3.0.0. Always use `+sep`.

## Don't Hand-Roll

| Problem | Don't Build | Use Instead | Why |
|---------|-------------|-------------|-----|
| Multi-value splitting | Custom `#arraymap` + inline annotation | `+sep=,` inside `#set` | Official SMW parameter, simpler, stays in `#set` block |
| Empty parameter detection | Complex nested conditionals | `{{#if:{{{param\|}}}|...\|}}` | Standard MediaWiki pattern, handles both undefined and empty |
| Migration scripts | Custom migration tool | Existing regeneration path | StateManager hash change naturally flags templates as dirty |

## Common Pitfalls

### Pitfall 1: `#set` Called Before `#if` Resolves
**What goes wrong:** In some MediaWiki parser edge cases, `#set` may execute before `#if` fully resolves, causing empty values to be stored despite the conditional.
**Why it happens:** MediaWiki parser function execution order can be non-intuitive with nested calls.
**How to avoid:** Place `#if` INSIDE the property value expression (as shown in recommended pattern), not wrapping the entire `#set` call. The pattern `| Property = {{#if:{{{param|}}}|value|}}` is safe because SMW receives either the value or an empty string from the `#if` result, and an empty property value in `#set` is effectively a no-op.
**Warning signs:** Properties being stored with empty string values in Special:Browse.

### Pitfall 2: Multiple `#set` Calls Accumulate, Don't Overwrite
**What goes wrong:** When multiple templates on the same page call `#set` for the same property, SMW stores ALL non-empty values (accumulation), not just the last one.
**Why it happens:** This is by design in SMW -- properties are multi-valued by nature.
**How to avoid:** This is actually the DESIRED behavior for the multi-category use case. When Template:Person/semantic sets `Has full name = John` and Template:Faculty/semantic passes empty for `Has full name`, the `#if` guard prevents the empty write, so only "John" is stored. This is exactly the success criterion.
**Warning signs:** A property showing duplicate values in Special:Browse (would indicate `#if` guard not working).

### Pitfall 3: Boolean Properties and Empty String Ambiguity
**What goes wrong:** An unchecked checkbox sends an empty string, which `#if` treats as falsy. A checkbox explicitly set to "false" also sends a non-empty string.
**Why it happens:** PageForms checkbox input sends "Yes"/"No" or similar truthy/falsy strings. An unchecked checkbox typically sends nothing (empty parameter).
**How to avoid:** The `#if` guard works correctly here: an unchecked checkbox (empty) skips the `#set`, a "No"/"false" value is non-empty and gets stored. This is the desired behavior -- we want to store explicit "false" values but skip unset ones.
**Warning signs:** Boolean properties not being stored when explicitly set to false. Test with actual PageForms checkbox output.

### Pitfall 4: `+sep` with Trailing Comma Creates Empty Values
**What goes wrong:** If a multi-value parameter ends with a comma (e.g., `value1,value2,`), `+sep=,` will create an empty value as the last entry.
**Why it happens:** SMW splits on the separator character literally.
**How to avoid:** The `#if` guard around the entire value prevents the `+sep` from executing on an empty string. For non-empty values with trailing commas, this is a PageForms concern -- the `tokens` input type does not typically produce trailing commas. No special handling needed.
**Warning signs:** Extra empty values appearing in SMW property listings.

### Pitfall 5: Namespace-Prefixed Multi-Value Page Properties
**What goes wrong:** The current `#arraymap` approach for multi-value Page properties with `allowedNamespace` adds a namespace prefix to each value individually. Switching to `+sep` alone would lose this prefix.
**Why it happens:** `+sep` splits the value string but doesn't transform individual values.
**How to avoid:** For properties that are both multi-value AND have `allowedNamespace` (e.g., `Has optional subgroup` with `allowedNamespace: Subobject`), retain the `#arraymap` approach but wrap it in `#if`. Alternatively, if PageForms already stores the full `Namespace:Value` format via the tokens input, `+sep` may work directly.
**Warning signs:** Values stored without namespace prefix, broken SMW page references.

## Code Examples

### Example 1: Standard Property with `#if` Guard

Current (`generatePropertyLine` returns):
```
 | Has email = {{{email|}}}
```

New:
```php
// In generatePropertyLine()
return ' | ' . $propertyName . ' = {{#if:{{{' . $param . '|}}}|{{{' . $param . '|}}}|}}';
```

Output:
```
 | Has email = {{#if:{{{email|}}}|{{{email|}}}|}}
```

### Example 2: Multi-Value Property with `+sep`

Current (multi-value non-Page-type property):
```
 | Has keywords = {{{keywords|}}}
```

New:
```php
// In generatePropertyLine(), when property allowsMultipleValues()
return ' | ' . $propertyName . ' = {{#if:{{{' . $param . '|}}}|{{{' . $param . '|}}}|}}|+sep=,';
```

Output:
```
 | Has keywords = {{#if:{{{keywords|}}}|{{{keywords|}}}|}}|+sep=,
```

### Example 3: Page-Type with Namespace Prefix (Single-Value, Already Conditional)

Current:
```
 | Has display pattern = {{#if:{{{display_pattern|}}}|Property:{{{display_pattern|}}}|}}
```

New (no change needed, already has `#if` guard):
```
 | Has display pattern = {{#if:{{{display_pattern|}}}|Property:{{{display_pattern|}}}|}}
```

### Example 4: Multi-Value Page-Type with Namespace Prefix

Current (inline annotation outside `#set`):
```
{{#arraymap:{{{optional_subgroup|}}}|,|@@item@@|[[Has optional subgroup::Subobject:@@item@@]]|}}
```

New (wrapped in `#if`, still inline annotation):
```
{{#if:{{{optional_subgroup|}}}|{{#arraymap:{{{optional_subgroup|}}}|,|@@item@@|[[Has optional subgroup::Subobject:@@item@@]]|}}|}}
```

### Example 5: Complete Semantic Template (After)

For a `Person` category with properties `Has email`, `Has full name`, `Has biography`, `Has keywords` (multi-value):

```
<noinclude>
<!-- AUTO-GENERATED by SemanticSchemas - DO NOT EDIT MANUALLY -->
Semantic template for Category:Person
</noinclude><includeonly>
{{#set:
 | Has biography = {{#if:{{{biography|}}}|{{{biography|}}}|}}
 | Has email = {{#if:{{{email|}}}|{{{email|}}}|}}
 | Has full name = {{#if:{{{full_name|}}}|{{{full_name|}}}|}}
 | Has keywords = {{#if:{{{keywords|}}}|{{{keywords|}}}|}}|+sep=,
}}

[[Category:Person]]
</includeonly>
```

### Example 6: Subobject Template (After)

```
<noinclude>
<!-- AUTO-GENERATED by SemanticSchemas - DO NOT EDIT MANUALLY -->
Subobject semantic template for Subobject:PublicationAuthor
</noinclude><includeonly>
{{#subobject:
 | Has subobject type = Subobject:PublicationAuthor
 | Has author = {{#if:{{{author|}}}|{{{author|}}}|}}
 | Has author order = {{#if:{{{author_order|}}}|{{{author_order|}}}|}}
 | Is co-first author = {{#if:{{{co-first_author|}}}|{{{co-first_author|}}}|}}
 | Is corresponding author = {{#if:{{{corresponding_author|}}}|{{{corresponding_author|}}}|}}
}}
</includeonly>
```

## State of the Art

| Old Approach | Current Approach | When Changed | Impact |
|--------------|------------------|--------------|--------|
| Pipe-based multi-values in `#set` | `+sep=` parameter | SMW 1.9.0 (2014), pipes deprecated SMW 3.0.0 | Must use `+sep`, pipe syntax will be removed |
| `#arraymap` for multi-value in `#set` | `+sep=,` inside `#set` | Available since SMW 1.9.0 | Simpler, cleaner, stays within `#set` block |
| No guards on `#set` properties | `#if` guards per property | Best practice for template-based annotation | Prevents empty value pollution in SMW store |

## SMW Behavior: Critical Findings

### Multiple `#set` Calls for Same Property (HIGH confidence)
When multiple templates on the same page call `#set` for the same property, SMW **accumulates all values** -- it does NOT do "last write wins." This means:
- Template A sets `Has email = john@example.com`
- Template B sets `Has email =` (empty, but without `#if` guard, stores empty)
- Result: Page has TWO values for `Has email`: "john@example.com" AND "" (empty)

With `#if` guards:
- Template A sets `Has email = john@example.com` (non-empty, stored)
- Template B has `#if` guard, skips empty `Has email`
- Result: Page has ONE value: "john@example.com" (correct)

Source: [SMW Help: Setting values](https://www.semantic-mediawiki.org/wiki/Help:Setting_values)

### Empty Values in `#set` (HIGH confidence)
SMW does not gracefully handle empty values passed to `#set`. Documented issues include:
- `#set` may break on empty substrings
- Empty annotations may be stored as blank property values
- Querying for empty string values returns "Empty strings are not accepted"

The `#if` guard is the officially recommended workaround.

Source: [SMW Help talk: Setting values](https://www.semantic-mediawiki.org/wiki/Help_talk:Setting_values)

### `+sep` Behavior Details (HIGH confidence)
- Per-property, not global: Each property line can have its own `+sep` character
- Comma is default when `+sep` is specified without a character
- Leading/trailing spaces on outer values are trimmed
- Trailing separator creates empty value entry
- Works with `#subobject` identically to `#set`

Source: [SMW Help: Separator parameter](https://www.semantic-mediawiki.org/wiki/Help:Setting_values/Working_with_the_separator_parameter)

### `#if` with Template Parameters (HIGH confidence)
- `{{{param|}}}` (with empty default via trailing pipe) evaluates to empty string when parameter is undefined or empty
- `{{{param}}}` (without pipe) evaluates to literal string `{{{param}}}` when undefined, which `#if` treats as truthy (bug-prone)
- `#if` trims whitespace, so `" "` (space only) is treated as falsy
- MediaWiki always use `{{{param|}}}` inside `#if` for correct emptiness checks

Source: [MediaWiki Help: Parser functions in templates](https://www.mediawiki.org/wiki/Help:Parser_functions_in_templates)

## Open Questions

1. **Multi-value Page properties with `allowedNamespace` and `+sep`**
   - What we know: Currently these use `#arraymap` to add namespace prefix per-value. `+sep` cannot add per-value namespace prefixes.
   - What's unclear: Does PageForms `tokens` input store values WITH the namespace prefix already (e.g., "Subobject:MyItem" not just "MyItem")? If yes, `+sep` works. If no, `#arraymap` must be retained.
   - Recommendation: Keep `#arraymap` for these specific properties (multi-value + Page-type + `allowedNamespace`), but wrap in `#if`. This is the safer approach and only affects a small number of properties. Convert to `+sep` only for multi-value properties WITHOUT namespace prefix requirements.

2. **Whitespace-only parameter values**
   - What we know: `#if` treats whitespace-only strings as falsy (trimming behavior).
   - What's unclear: Could a property legitimately have a whitespace-only value that should be stored?
   - Recommendation: Rely on `#if` default trimming. No real-world property value would be whitespace-only. This is safe.

3. **`+sep` placement relative to `#if` in wikitext**
   - What we know: The syntax is `| Property = value|+sep=,` where `+sep` is parsed by SMW as a parameter of the property line.
   - What's unclear: When `#if` returns empty string, does `|+sep=,` still cause SMW to process an empty multi-value split?
   - Recommendation: Test this during implementation. If needed, the `+sep` can be moved inside the `#if`: `| Property = {{#if:{{{param|}}}|{{{param|}}}|+sep=,|}}`. However, this changes semantics. Most likely, an empty value before `+sep` simply produces no stored values, which is the desired behavior.

## Sources

### Primary (HIGH confidence)
- **Codebase analysis**: `src/Generator/TemplateGenerator.php` -- full read, line-by-line analysis of current output patterns
- **Codebase analysis**: `src/Schema/PropertyModel.php` -- `allowsMultipleValues()`, `isPageType()`, `getAllowedNamespace()` API
- **Codebase analysis**: `src/Schema/CategoryModel.php` -- property organization (required/optional/all)
- **Codebase analysis**: `src/Generator/PropertyInputMapper.php` -- `tokens` input type for multi-value, comma delimiter convention
- **Codebase analysis**: `src/Util/NamingHelper.php` -- `propertyToParameter()` naming convention
- **Codebase analysis**: `src/Store/StateManager.php` -- hash-based dirty detection confirms natural migration path
- **Codebase analysis**: `tests/phpunit/unit/Generator/TemplateGeneratorTest.php` -- existing test patterns and assertions

### Secondary (MEDIUM confidence)
- [SMW Help: Setting values](https://www.semantic-mediawiki.org/wiki/Help:Setting_values) -- `#set` behavior, multiple values
- [SMW Help: Separator parameter](https://www.semantic-mediawiki.org/wiki/Help:Setting_values/Working_with_the_separator_parameter) -- `+sep` syntax and behavior
- [SMW Help: Separator examples](https://www.semantic-mediawiki.org/wiki/Help:Setting_values/Working_with_the_separator_parameter/Example_for_setting_multiple_values_using_the_sep_parameter) -- concrete `+sep` usage examples
- [MediaWiki Help: Parser functions in templates](https://www.mediawiki.org/wiki/Help:Parser_functions_in_templates) -- `#if` and `{{{param|}}}` behavior
- [SMW Help: Type Boolean](https://www.semantic-mediawiki.org/wiki/Help:Type_Boolean) -- Boolean property behavior
- [SMW Help talk: Setting values](https://www.semantic-mediawiki.org/wiki/Help_talk:Setting_values) -- known issues with empty values in `#set`
- [PageForms: Input types](https://www.mediawiki.org/wiki/Extension:Page_Forms/Input_types) -- tokens input, comma delimiter

### Tertiary (LOW confidence)
- Community discussion on multiple `#set` calls accumulation behavior (consistent across multiple sources but primarily from community forums)

## Metadata

**Confidence breakdown:**
- Standard stack: HIGH -- no new libraries, all patterns from official SMW/MW documentation
- Architecture: HIGH -- codebase fully analyzed, modification scope clear and narrow
- Pitfalls: HIGH -- empty value behavior and `#set` accumulation well-documented in SMW
- `+sep` syntax: HIGH -- official documentation with examples
- Boolean handling: MEDIUM -- behavior follows logically from `#if` semantics but should be validated with actual PageForms checkbox output
- Namespace-prefixed multi-value: MEDIUM -- unclear whether PageForms stores with prefix, needs testing

**Research date:** 2026-02-02
**Valid until:** 2026-03-02 (stable domain, SMW parser functions rarely change)
