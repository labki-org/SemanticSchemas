---
phase: 05-property-resolution
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/Schema/ResolvedPropertySet.php
  - src/Schema/MultiCategoryResolver.php
  - tests/phpunit/unit/Schema/MultiCategoryResolverTest.php
autonomous: true

must_haves:
  truths:
    - "MultiCategoryResolver accepts one or more category names and returns a ResolvedPropertySet"
    - "Shared properties (same name across categories) appear once in output, attributed to all source categories"
    - "When a property is required in any category, it is required in the merged result (silent promotion)"
    - "Subobjects are resolved identically to properties (same deduplication, same required promotion)"
    - "Single-category input returns that category's inherited properties wrapped in ResolvedPropertySet"
    - "Empty input returns an empty ResolvedPropertySet with no properties or subobjects"
    - "Property ordering preserves C3 accumulation order per category, first-seen across categories"
  artifacts:
    - path: "src/Schema/ResolvedPropertySet.php"
      provides: "Immutable value object holding merged property resolution result"
      exports: ["ResolvedPropertySet"]
      contains: "class ResolvedPropertySet"
    - path: "src/Schema/MultiCategoryResolver.php"
      provides: "Cross-category property resolver composing InheritanceResolver"
      exports: ["MultiCategoryResolver"]
      contains: "class MultiCategoryResolver"
    - path: "tests/phpunit/unit/Schema/MultiCategoryResolverTest.php"
      provides: "Unit tests for resolver and value object"
      contains: "class MultiCategoryResolverTest"
  key_links:
    - from: "src/Schema/MultiCategoryResolver.php"
      to: "src/Schema/InheritanceResolver.php"
      via: "constructor dependency injection"
      pattern: "InheritanceResolver.*inheritanceResolver"
    - from: "src/Schema/MultiCategoryResolver.php"
      to: "src/Schema/ResolvedPropertySet.php"
      via: "resolve() return type"
      pattern: "ResolvedPropertySet"
    - from: "src/Schema/MultiCategoryResolver.php"
      to: "InheritanceResolver::getEffectiveCategory"
      via: "per-category resolution before cross-category merge"
      pattern: "getEffectiveCategory"
---

<objective>
Create the multi-category property resolver that accepts one or more category names, resolves inherited properties via InheritanceResolver, then merges and deduplicates across categories into a ResolvedPropertySet value object.

Purpose: This is the core resolution layer consumed by Form Generation (Phase 6), API (Phase 7), and UI (Phase 8). It replaces direct InheritanceResolver calls as the universal entry point for property resolution, even for single-category pages.

Output: Two new source files (MultiCategoryResolver, ResolvedPropertySet) and one test file with comprehensive unit test coverage.
</objective>

<execution_context>
@/home/daharoni/.claude/get-shit-done/workflows/execute-plan.md
@/home/daharoni/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-property-resolution/05-CONTEXT.md
@.planning/phases/05-property-resolution/05-RESEARCH.md
@src/Schema/InheritanceResolver.php
@src/Schema/CategoryModel.php
@src/Schema/SubobjectModel.php
@tests/phpunit/unit/Schema/InheritanceResolverTest.php
@tests/phpunit/unit/Schema/CategoryModelTest.php
@tests/phpunit/bootstrap.php
@phpunit.xml.dist
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ResolvedPropertySet value object</name>
  <files>src/Schema/ResolvedPropertySet.php</files>
  <action>
Create `src/Schema/ResolvedPropertySet.php` as an immutable value object in namespace `MediaWiki\Extension\SemanticSchemas\Schema`.

Constructor accepts:
- `array $requiredProperties` (string[]) - deduplicated required property names
- `array $optionalProperties` (string[]) - deduplicated optional property names (already promoted away from required)
- `array $propertySources` (array<string, string[]>) - map of property name to list of category names that define it
- `array $requiredSubobjects` (string[]) - deduplicated required subobject names
- `array $optionalSubobjects` (string[]) - deduplicated optional subobject names
- `array $subobjectSources` (array<string, string[]>) - map of subobject name to list of category names
- `array $categoryNames` (string[]) - all input category names

All parameters stored as private readonly fields. No setters.

Public API (all return types match CategoryModel conventions):
- `getRequiredProperties(): array` - returns string[]
- `getOptionalProperties(): array` - returns string[]
- `getAllProperties(): array` - returns merged required + optional (same pattern as CategoryModel::getAllProperties using array_values + array_unique + array_merge)
- `getPropertySources( string $property ): array` - returns string[] of category names, empty array if property not found
- `isSharedProperty( string $property ): bool` - returns count(sources) > 1
- `getRequiredSubobjects(): array` - returns string[]
- `getOptionalSubobjects(): array` - returns string[]
- `getAllSubobjects(): array` - returns merged required + optional
- `getSubobjectSources( string $subobject ): array` - returns string[] of category names
- `isSharedSubobject( string $subobject ): bool` - returns count(sources) > 1
- `getCategoryNames(): array` - returns string[] of all input category names

Follow existing code style:
- Use MediaWiki PHP code style (tabs for indentation, space after function keyword in closures)
- PHPDoc blocks matching CategoryModel style
- Section comment headers matching CategoryModel pattern (`/* --- SECTION --- */`)
- No dependencies on MediaWiki classes (pure PHP)

Provide a static factory `empty()` method that returns an empty ResolvedPropertySet (all arrays empty) for the zero-categories edge case.
  </action>
  <verify>Run `composer test` -- all existing tests still pass and no lint errors on the new file. Run `php -l src/Schema/ResolvedPropertySet.php` to confirm no syntax errors.</verify>
  <done>ResolvedPropertySet.php exists with all accessors documented above. File has no MediaWiki dependencies. Matches project code style (phpcs passes).</done>
</task>

<task type="auto">
  <name>Task 2: Create MultiCategoryResolver and unit tests</name>
  <files>src/Schema/MultiCategoryResolver.php, tests/phpunit/unit/Schema/MultiCategoryResolverTest.php</files>
  <action>
**MultiCategoryResolver (src/Schema/MultiCategoryResolver.php):**

Create in namespace `MediaWiki\Extension\SemanticSchemas\Schema`.

Constructor: accepts `InheritanceResolver $inheritanceResolver` (composition, not inheritance).

Single public method: `resolve( array $categoryNames ): ResolvedPropertySet`

Algorithm (from research, proven correct):
1. If `$categoryNames` is empty, return `ResolvedPropertySet::empty()`.
2. Initialize: `$allRequired = []`, `$allOptional = []`, `$propertySources = []`, and identical arrays for subobjects (`$allRequiredSub`, `$allOptionalSub`, `$subobjectSources`).
3. For each category name in `$categoryNames`:
   a. Call `$this->inheritanceResolver->getEffectiveCategory( $name )` to get the fully-inherited CategoryModel.
   b. For each required property: if not already in `$allRequired`, append it. Add category name to `$propertySources[$prop][]`.
   c. For each optional property: if not in `$allRequired` AND not in `$allOptional`, append to `$allOptional`. Add category name to `$propertySources[$prop][]`.
   d. Repeat steps b-c identically for subobjects (getRequiredSubobjects, getOptionalSubobjects).
4. Silent promotion: `$allOptional = array_values( array_diff( $allOptional, $allRequired ) )`. Same for subobjects.
5. Deduplicate sources: for each property/subobject, `array_values( array_unique( $sources ) )`.
6. Return `new ResolvedPropertySet( $allRequired, $allOptional, $propertySources, $allRequiredSub, $allOptionalSub, $subobjectSources, $categoryNames )`.

No datatype conflict checking (impossible by design per CONTEXT.md, satisfies RESO-05 by design). Add a brief doc comment on the class explaining why: "Property datatypes cannot conflict across categories because properties are wiki-global entities identified by page title."

**Unit Tests (tests/phpunit/unit/Schema/MultiCategoryResolverTest.php):**

Create in namespace `MediaWiki\Extension\SemanticSchemas\Tests\Unit\Schema`.

Follow InheritanceResolverTest.php conventions:
- `@covers` annotation for MultiCategoryResolver
- Section comment headers separating test groups
- Direct CategoryModel and InheritanceResolver construction (no MediaWiki dependencies)

Test cases (each is a separate test method):

1. **testEmptyInputReturnsEmptyResult** - `resolve([])` returns empty ResolvedPropertySet. Assert all getters return `[]`.

2. **testSingleCategoryReturnsItsProperties** - One category with required and optional properties. Assert getRequiredProperties, getOptionalProperties, getCategoryNames match input.

3. **testSingleCategoryIncludesSubobjects** - One category with required and optional subobjects. Assert getRequiredSubobjects, getOptionalSubobjects match.

4. **testSharedPropertyDeduplication** - Two categories both defining "Has name" as required. Assert "Has name" appears once in getAllProperties, `isSharedProperty('Has name')` returns true, `getPropertySources('Has name')` returns both category names.

5. **testOptionalPromotedToRequiredAcrossCategories** - Category A has "Has phone" as optional, Category B has "Has phone" as required. Assert "Has phone" is in getRequiredProperties and NOT in getOptionalProperties.

6. **testDisjointCategoriesMergeAllProperties** - Two categories with no shared properties. Assert all properties from both appear. No properties are shared.

7. **testSharedSubobjectDeduplication** - Two categories sharing a subobject. Assert deduplication and source attribution work identically to properties.

8. **testSubobjectOptionalPromotedToRequired** - Same promotion test but for subobjects.

9. **testPropertyOrderPreservesCategoryInputOrder** - Category A has props [X, Y], Category B has props [Z, W]. Assert getAllProperties returns them in order: X, Y, Z, W (first-seen from input order).

10. **testInheritedPropertiesIncluded** - Category "Student" inherits from "Person". Resolve with just ["Student"]. Assert parent properties are present (getEffectiveCategory already handles this).

11. **testDiamondInheritanceDeduplication** - Two categories sharing a common ancestor. Shared ancestor's properties appear once, attributed to both categories.

12. **testSourcesForUnknownPropertyReturnsEmptyArray** - Call `getPropertySources('Nonexistent')` returns `[]`.

13. **testIsSharedReturnsFalseForSingleSourceProperty** - A property from only one category. `isSharedProperty` returns false.

14. **testEmptyCategoryContributesNothingButAppearsInCategoryNames** - A category with no properties. It appears in `getCategoryNames()` but contributes nothing to property lists.
  </action>
  <verify>Run `php vendor/bin/phpunit tests/phpunit/unit/Schema/MultiCategoryResolverTest.php` -- all 14 tests pass. Run `composer test` -- all existing tests still pass and no lint/style errors.</verify>
  <done>MultiCategoryResolver.php and MultiCategoryResolverTest.php exist. All 14 test methods pass. Resolver uses InheritanceResolver via composition, returns ResolvedPropertySet. No MediaWiki dependencies in tests. `composer test` clean.</done>
</task>

</tasks>

<verification>
After both tasks complete:

1. `composer test` passes with zero errors (lint + phpcs + existing tests)
2. `php vendor/bin/phpunit tests/phpunit/unit/Schema/MultiCategoryResolverTest.php` -- all 14 tests pass
3. `php vendor/bin/phpunit` -- full test suite passes (existing + new tests)
4. No MediaWiki dependencies in new files (grep for `use MediaWiki\\` in new files should only show the namespace declaration, not MW service imports)

Requirements coverage:
- RESO-01: resolve() accepts multiple category names, returns ResolvedPropertySet (tests 1-14)
- RESO-02: Shared properties deduplicated (tests 4, 7)
- RESO-03: Property ordering follows C3 precedence within each category (test 9, 10)
- RESO-04: Source attribution via getPropertySources/getSubobjectSources (tests 4, 7, 12)
- RESO-05: Satisfied by design -- properties are wiki-global entities, no conflict possible (doc comment)
- RESO-06: Required promotion across categories (tests 5, 8)
</verification>

<success_criteria>
- MultiCategoryResolver.resolve() works for 0, 1, and N categories
- ResolvedPropertySet provides typed accessors for properties, subobjects, and sources
- Shared properties deduplicated with correct source attribution
- Required/optional promotion follows silent promotion pattern (array_diff)
- Subobjects handled identically to properties throughout
- All tests pass, composer test clean, no MediaWiki dependencies in new code
</success_criteria>

<output>
After completion, create `.planning/phases/05-property-resolution/05-01-SUMMARY.md`
</output>
