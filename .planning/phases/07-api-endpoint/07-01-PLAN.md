---
phase: 07-api-endpoint
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/Api/ApiSemanticSchemasMultiCategory.php
  - extension.json
  - i18n/en.json
  - tests/phpunit/unit/Api/ApiSemanticSchemasMultiCategoryTest.php
autonomous: true

must_haves:
  truths:
    - "API endpoint action=semanticschemas-multicategory accepts pipe-separated category names"
    - "API returns resolved properties with required/shared flags and source attribution"
    - "API returns resolved subobjects with required/shared flags and source attribution"
    - "Invalid category names fail the entire request with error message"
    - "Single-category requests work (minimum 1, not 2)"
    - "Category: namespace prefix is stripped automatically"
    - "Edit permission is required to call the API"
  artifacts:
    - path: "src/Api/ApiSemanticSchemasMultiCategory.php"
      provides: "API module extending ApiBase for multi-category property resolution"
      contains: "class ApiSemanticSchemasMultiCategory extends ApiBase"
    - path: "extension.json"
      provides: "API module registration"
      contains: "semanticschemas-multicategory"
    - path: "i18n/en.json"
      provides: "API help and error messages"
      contains: "apihelp-semanticschemas-multicategory"
    - path: "tests/phpunit/unit/Api/ApiSemanticSchemasMultiCategoryTest.php"
      provides: "Unit tests for API response formatting and validation"
      contains: "class ApiSemanticSchemasMultiCategoryTest"
  key_links:
    - from: "src/Api/ApiSemanticSchemasMultiCategory.php"
      to: "MultiCategoryResolver"
      via: "constructor composition"
      pattern: "new MultiCategoryResolver"
    - from: "src/Api/ApiSemanticSchemasMultiCategory.php"
      to: "WikiCategoryStore"
      via: "getAllCategories for validation"
      pattern: "getAllCategories"
    - from: "extension.json"
      to: "src/Api/ApiSemanticSchemasMultiCategory.php"
      via: "APIModules registration"
      pattern: "semanticschemas-multicategory.*ApiSemanticSchemasMultiCategory"
---

<objective>
Create the multi-category property resolution API endpoint that accepts pipe-separated category names and returns resolved properties and subobjects with per-item metadata.

Purpose: Phase 8 (Create Page UI) needs this API to fetch property resolution data when users select categories in the UI. This endpoint delegates to MultiCategoryResolver (Phase 5) and formats the result as JSON.

Output: Working API endpoint registered in extension.json, with i18n messages and unit tests.
</objective>

<execution_context>
@/home/daharoni/.claude/get-shit-done/workflows/execute-plan.md
@/home/daharoni/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-api-endpoint/07-CONTEXT.md
@.planning/phases/07-api-endpoint/07-RESEARCH.md
@.planning/phases/05-property-resolution/05-01-SUMMARY.md

Key source files to reference during implementation:
@src/Api/ApiSemanticSchemasHierarchy.php (follow this pattern exactly for structure, stripPrefix, normalizeRequiredFlags, needsToken, isReadMode, getAllowedParams, getExamplesMessages)
@src/Schema/MultiCategoryResolver.php (delegate to resolve())
@src/Schema/ResolvedPropertySet.php (use getters for response formatting)
@src/Store/WikiCategoryStore.php (getAllCategories for validation)
@extension.json (add APIModules entry)
@i18n/en.json (add message keys)
@tests/phpunit/unit/Schema/MultiCategoryResolverTest.php (follow test structure pattern)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create API module, register, and add i18n messages</name>
  <files>
    src/Api/ApiSemanticSchemasMultiCategory.php
    extension.json
    i18n/en.json
  </files>
  <action>
Create `src/Api/ApiSemanticSchemasMultiCategory.php` following the ApiSemanticSchemasHierarchy pattern exactly. The class must:

1. **Extend ApiBase** with namespace `MediaWiki\Extension\SemanticSchemas\Api`

2. **execute() method** (in this order):
   - Call `$this->checkUserRightsAny( 'edit' )` (user decision: require edit permission)
   - Extract params via `$this->extractRequestParams()`
   - Normalize category names: `array_map( [ $this, 'stripPrefix' ], $params['categories'] )`
   - Load all categories via `$categoryStore = new WikiCategoryStore()` then `$allCategories = $categoryStore->getAllCategories()`
   - Validate ALL categories exist (see validateCategories below). If any invalid, call `$this->dieWithError()` (user decision: fail entire request, no partial resolution)
   - Create resolver: `$inheritanceResolver = new InheritanceResolver( $allCategories )` then `$multiResolver = new MultiCategoryResolver( $inheritanceResolver )`
   - Resolve: `$resolved = $multiResolver->resolve( $categoryNames )`
   - Build response array with 'categories', 'properties', 'subobjects' keys
   - Add result via `$this->getResult()->addValue( null, $this->getModuleName(), $response )`

3. **validateCategories( array $categoryNames, array $allCategories )** private method:
   - Collect names not found in `$allCategories` keys
   - If any invalid, call `$this->dieWithError( [ 'apierror-semanticschemas-invalidcategories', implode( ', ', $invalidCategories ) ], 'invalidcategories' )`

4. **stripPrefix( string $name )** private method:
   - `return preg_replace( '/^Category:/i', '', trim( $name ) )`

5. **formatProperties( ResolvedPropertySet $resolved )** private method:
   - Iterate required properties: for each, build array with 'name', 'title' (prefix "Property:"), 'required' => 1, 'shared' => (count sources > 1 ? 1 : 0), 'sources' => sources array
   - Iterate optional properties: same but 'required' => 0
   - Return merged array

6. **formatSubobjects( ResolvedPropertySet $resolved )** private method:
   - Same pattern as formatProperties but prefix "Subobject:" for title, use getRequiredSubobjects/getOptionalSubobjects/getSubobjectSources

7. **getAllowedParams()** - return array with 'categories' param:
   - `self::PARAM_TYPE => 'string'`
   - `self::PARAM_ISMULTI => true`
   - `self::PARAM_REQUIRED => true`
   - `self::PARAM_ISMULTI_LIMIT1 => 10` (normal users)
   - `self::PARAM_ISMULTI_LIMIT2 => 20` (bots/privileged)
   - `self::PARAM_HELP_MSG => 'semanticschemas-api-param-categories'`

8. **getExamplesMessages()** - 3 examples:
   - `action=semanticschemas-multicategory&categories=Person` => single category
   - `action=semanticschemas-multicategory&categories=Person|Employee` => multi-category
   - `action=semanticschemas-multicategory&categories=Category:Person|Employee` => with prefix

9. **needsToken()** returns false (read-only)
10. **isReadMode()** returns true

Use imports: `ApiBase`, `WikiCategoryStore`, `InheritanceResolver`, `MultiCategoryResolver`, `ResolvedPropertySet`.

**Register in extension.json:** Add to the `APIModules` object:
```
"semanticschemas-multicategory": "MediaWiki\\Extension\\SemanticSchemas\\Api\\ApiSemanticSchemasMultiCategory"
```

**Add i18n messages to i18n/en.json** (add after existing semanticschemas-api-param-parents entry):
- `"semanticschemas-api-param-categories"`: `"Category names to resolve (with or without 'Category:' prefix). Pipe-separated for multiple categories."`
- `"apihelp-semanticschemas-multicategory-summary"`: `"Resolve properties and subobjects across one or more categories."`
- `"apihelp-semanticschemas-multicategory-example-1"`: `"Resolve properties for Person category"`
- `"apihelp-semanticschemas-multicategory-example-2"`: `"Resolve properties for Person and Employee categories"`
- `"apihelp-semanticschemas-multicategory-example-3"`: `"Resolve properties with namespace prefix"`
- `"apierror-semanticschemas-invalidcategories"`: `"Invalid categories: $1"`

Follow existing code style: tabs for indentation, MediaWiki PHPDoc conventions, section comment separators matching ApiSemanticSchemasHierarchy.
  </action>
  <verify>
Run `composer test` to confirm phpcs/parallel-lint pass. Verify the new file has no syntax errors.
  </verify>
  <done>
ApiSemanticSchemasMultiCategory.php exists and passes linting. Extension.json registers the module. i18n/en.json contains all message keys.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create unit tests for API response formatting</name>
  <files>
    tests/phpunit/unit/Api/ApiSemanticSchemasMultiCategoryTest.php
  </files>
  <action>
Create `tests/phpunit/unit/Api/ApiSemanticSchemasMultiCategoryTest.php` as a unit test that tests the formatting and validation logic without requiring MediaWiki integration.

Since ApiBase methods (execute, dieWithError, checkUserRightsAny) require MediaWiki integration, test the API module's formatting logic by making formatProperties() and formatSubobjects() protected (not private) and testing via a subclass or reflection. Alternatively, if the existing test patterns in this codebase use a simpler approach, follow that.

**Recommended approach:** Extract the formatting logic into testable methods. Make `formatProperties` and `formatSubobjects` `protected` instead of `private` so a test subclass can call them directly. Also make `stripPrefix` and `validateCategories` logic testable.

Create test class `ApiSemanticSchemasMultiCategoryTest extends TestCase` in namespace `MediaWiki\Extension\SemanticSchemas\Tests\Unit\Api`.

**Test a helper subclass** (TestableApiSemanticSchemasMultiCategory or use ReflectionMethod) to access protected methods.

**Test cases to cover:**

1. **formatProperties with required and optional:**
   - Create a ResolvedPropertySet with known required/optional properties and sources
   - Call formatProperties, assert output array has correct structure: name, title ("Property:" prefix), required (1 or 0 integer), shared (1 or 0 integer), sources (string array)

2. **formatProperties shared flag:**
   - Property with 2+ sources has shared=1
   - Property with 1 source has shared=0

3. **formatSubobjects mirrors properties:**
   - Same structure test but with "Subobject:" title prefix
   - Required/optional/shared flags work identically

4. **stripPrefix normalization:**
   - "Category:Person" -> "Person"
   - "category:Person" -> "Person" (case insensitive)
   - "Person" -> "Person" (no prefix, unchanged)
   - " Person " -> "Person" (trimmed)

5. **Empty resolution returns empty arrays:**
   - ResolvedPropertySet::empty() produces empty properties/subobjects arrays

6. **Boolean flags are integers not booleans:**
   - Assert required/shared values are strictly `1` or `0` (use assertSame with int type)

Follow the test file structure from MultiCategoryResolverTest.php: section comment separators, PHPUnit\Framework\TestCase, @covers annotation.
  </action>
  <verify>
Run `php vendor/bin/phpunit tests/phpunit/unit/Api/ApiSemanticSchemasMultiCategoryTest.php` to confirm all tests pass. Run `composer test` for full suite.
  </verify>
  <done>
All unit tests pass. Tests verify response formatting produces correct structure with integer boolean flags, namespace-prefixed titles, shared detection, and stripPrefix normalization.
  </done>
</task>

</tasks>

<verification>
1. `composer test` passes (phpcs, parallel-lint, minus-x)
2. `php vendor/bin/phpunit tests/phpunit/unit/Api/ApiSemanticSchemasMultiCategoryTest.php` passes
3. API module is registered in extension.json under APIModules
4. All i18n message keys present in i18n/en.json
5. Response uses integers (1/0) for boolean flags, not true/false
6. Properties have "Property:" title prefix, subobjects have "Subobject:" prefix
7. Categories parameter supports pipe-separated values with ISMULTI
8. Category: namespace prefix is stripped (case-insensitive)
</verification>

<success_criteria>
- API module class exists at src/Api/ApiSemanticSchemasMultiCategory.php
- Extends ApiBase, delegates to MultiCategoryResolver
- Requires edit permission via checkUserRightsAny
- Accepts pipe-separated categories with PARAM_ISMULTI (limit 10/20)
- Strips Category: prefix (case-insensitive)
- Validates all categories exist, fails entire request if any invalid
- Returns flat property/subobject arrays with name, title, required (int), shared (int), sources
- Registered in extension.json, i18n messages in en.json
- Unit tests cover formatting, normalization, and edge cases
- All linting and tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/07-api-endpoint/07-01-SUMMARY.md`
</output>
