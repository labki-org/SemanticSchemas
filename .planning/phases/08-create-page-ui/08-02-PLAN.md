---
phase: 08-create-page-ui
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/Special/SpecialCreateSemanticPage.php
  - extension.json
  - SemanticSchemas.alias.php
  - i18n/en.json
  - i18n/qqq.json
autonomous: true

must_haves:
  truths:
    - "Users with edit permissions can access Special:CreateSemanticPage"
    - "Users without edit permissions are denied access"
    - "Page renders HTML skeleton with containers for JS to populate"
    - "HTML skeleton embeds root category as data-root-category attribute on tree container"
    - "JS module ext.semanticschemas.createpage is loaded on the page"
    - "POST action=createpage with 1 category uses FormGenerator, with 2+ uses CompositeFormGenerator"
    - "POST action=createpage returns JSON with form name and FormEdit URL"
  artifacts:
    - path: "src/Special/SpecialCreateSemanticPage.php"
      provides: "Special page class with execute() and POST handler"
      contains: "class SpecialCreateSemanticPage"
    - path: "extension.json"
      provides: "SpecialPage and ResourceModule registration"
      contains: "CreateSemanticPage"
  key_links:
    - from: "extension.json"
      to: "src/Special/SpecialCreateSemanticPage.php"
      via: "SpecialPages registration"
      pattern: "CreateSemanticPage.*SpecialCreateSemanticPage"
    - from: "src/Special/SpecialCreateSemanticPage.php"
      to: "src/Generator/CompositeFormGenerator.php"
      via: "POST handler calls generateAndSaveCompositeForm for 2+ categories"
      pattern: "generateAndSaveCompositeForm"
    - from: "src/Special/SpecialCreateSemanticPage.php"
      to: "src/Generator/FormGenerator.php"
      via: "POST handler calls generateAndSaveForm for single category"
      pattern: "generateAndSaveForm"
    - from: "src/Special/SpecialCreateSemanticPage.php"
      to: "src/Store/WikiCategoryStore.php"
      via: "Root category lookup for data-root-category attribute"
      pattern: "WikiCategoryStore.*getAllCategories\\|getParents"
---

<objective>
Create the PHP Special page (SpecialCreateSemanticPage) with server-side registration, HTML skeleton, and POST handler for composite form generation.

Purpose: This is the server-side foundation for the Create Page UI. It registers the new Special page in MediaWiki, renders the HTML containers that JavaScript will populate (including the root category data attribute for the tree), and provides the POST endpoint that generates the composite form before the FormEdit redirect.

Output: Working Special page accessible at Special:CreateSemanticPage with permission checks, HTML layout skeleton with root category embedded, and server-side form generation handler supporting 1+ categories.
</objective>

<execution_context>
@/home/daharoni/.claude/get-shit-done/workflows/execute-plan.md
@/home/daharoni/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-create-page-ui/08-CONTEXT.md
@.planning/phases/08-create-page-ui/08-RESEARCH.md
@.planning/phases/06-composite-form-generation/06-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SpecialCreateSemanticPage PHP class</name>
  <files>src/Special/SpecialCreateSemanticPage.php</files>
  <action>
Create `src/Special/SpecialCreateSemanticPage.php` following the existing `SpecialSemanticSchemas.php` pattern.

**Class structure:**

```php
namespace MediaWiki\Extension\SemanticSchemas\Special;

use MediaWiki\Extension\SemanticSchemas\Generator\CompositeFormGenerator;
use MediaWiki\Extension\SemanticSchemas\Generator\FormGenerator;
use MediaWiki\Extension\SemanticSchemas\Schema\InheritanceResolver;
use MediaWiki\Extension\SemanticSchemas\Schema\MultiCategoryResolver;
use MediaWiki\Extension\SemanticSchemas\Store\WikiCategoryStore;
use MediaWiki\Html\Html;
use MediaWiki\SpecialPage\SpecialPage;

class SpecialCreateSemanticPage extends SpecialPage
```

**Constructor:** `parent::__construct('CreateSemanticPage', 'edit')` -- requires 'edit' permission (matches API endpoint decision from Phase 7).

**execute($subPage) method:**
1. `$this->setHeaders()` and `$this->checkPermissions()`
2. Check SMW_VERSION and PF_VERSION defined (show errorBox if missing, same pattern as SpecialSemanticSchemas)
3. Check for POST action: `$request->wasPosted() && $request->getVal('action') === 'createpage'` -- if true, call `$this->handleCreatePageAction()` and return
4. Load modules: `$output->addModules('ext.semanticschemas.createpage')` and `$output->addModuleStyles('ext.semanticschemas.styles')`
5. Render HTML layout via `$output->addHTML($this->renderLayout())`

**renderLayout() method** -- returns HTML string with semantic structure.

IMPORTANT: This method must look up the root category and embed it as a data attribute so the JS module can load the hierarchy tree without guessing.

Root category lookup:
- Instantiate `WikiCategoryStore` and call `getAllCategories()`
- Find the root: iterate categories and find one whose `getParents()` returns an empty array
- If multiple roots exist, pick the first alphabetically (deterministic)
- Embed on the tree container: `data-root-category="RootCategoryName"`

HTML structure:
```html
<div class="semanticschemas-shell ss-createpage-shell">
  <div class="ss-createpage-layout">
    <!-- Left panel: category tree -->
    <div class="ss-createpage-tree-panel">
      <h3>{msg:semanticschemas-createpage-tree-title}</h3>
      <div id="ss-createpage-tree" data-root-category="RootCategoryName"></div>
    </div>
    <!-- Right panel: preview + form -->
    <div class="ss-createpage-preview-panel">
      <h3>{msg:semanticschemas-createpage-preview-title}</h3>
      <!-- Chip list for selected categories -->
      <div id="ss-createpage-chips"></div>
      <!-- Property preview area -->
      <div id="ss-createpage-preview">
        <p class="ss-hierarchy-empty">{msg:semanticschemas-createpage-empty-state}</p>
      </div>
      <!-- Namespace picker (hidden by default, shown on conflict) -->
      <div id="ss-createpage-namespace" style="display:none;"></div>
      <!-- Page name + submit -->
      <div class="ss-createpage-submit-area">
        <label for="ss-createpage-pagename">{msg:semanticschemas-createpage-pagename-label}</label>
        <input type="text" id="ss-createpage-pagename" placeholder="{msg:semanticschemas-createpage-pagename-placeholder}" />
        <div id="ss-createpage-page-warning" style="display:none;"></div>
        <button id="ss-createpage-submit" class="ss-btn ss-btn-primary" disabled>{msg:semanticschemas-createpage-submit}</button>
      </div>
    </div>
  </div>
</div>
```

Use `Html::rawElement()`, `Html::element()`, and `$this->msg()` for all user-facing text. Follow existing SpecialSemanticSchemas pattern for safe HTML generation. The `data-root-category` attribute must use `Html::element()` or `htmlspecialchars()` to prevent XSS.

**handleCreatePageAction() method:**
1. Validate CSRF token: `$request->matchEditToken($request->getVal('wpEditToken'))` -- die with permission error if invalid
2. Get categories from POST: `$request->getArray('categories', [])` -- pipe-separated or array
3. Strip "Category:" prefix from each (same pattern as API)
4. Validate: at least 1 category (NOT 2 -- CONTEXT.md locks "disabled until at least one category is selected"), all must exist in WikiCategoryStore
5. Get page name: `$request->getVal('pagename', '')`
6. Get namespace: `$request->getVal('namespace', '')` (from namespace picker, may be empty)
7. Load all categories and build resolver: `WikiCategoryStore->getAllCategories()`, `InheritanceResolver($allCategories)`

8. Branch based on category count:
   **Single category (count === 1):**
   - Get effective category: `$resolver->getEffectiveCategory($categories[0])`
   - Generate form: `$formGenerator = new FormGenerator(); $formGenerator->generateAndSaveForm($effective)`
   - Form name is just the category name (standard single-category form naming)

   **Multiple categories (count >= 2):**
   - Resolve properties: `$multiResolver = new MultiCategoryResolver($resolver); $resolved = $multiResolver->resolve($categories)`
   - Generate form: `$compositeGenerator = new CompositeFormGenerator(); $compositeGenerator->generateAndSaveCompositeForm($resolved)`
   - Form name: `CompositeFormGenerator::getCompositeFormName($categories)` (alphabetical sort + "+" join)

9. Build target page: If namespace provided, prepend `Namespace:` to page name
10. Build FormEdit URL: `Special:FormEdit/$formName/$targetPage`
11. Return JSON response: `{ "success": true, "formName": "...", "formEditUrl": "Special:FormEdit/..." }`
12. On error: Return JSON: `{ "success": false, "error": "message" }`

Set response headers for JSON: `$output->disable()`, use `$this->getRequest()->response()->header('Content-Type: application/json')` and `echo json_encode(...)`.

**getGroupName():** Return `'wiki'` (same as existing pattern).

**doesWrites():** Return `true` (the POST handler writes wiki pages).
  </action>
  <verify>
Run `composer test` -- all checks pass (phpcs, parallel-lint, minus-x).
Verify class exists and follows PSR-4 autoloading via `AutoloadNamespaces` in extension.json.
Verify renderLayout() output includes `data-root-category` attribute on the tree container.
  </verify>
  <done>SpecialCreateSemanticPage class exists with execute(), renderLayout() (with root category data attribute), and handleCreatePageAction(). Permission checks enforce 'edit'. POST handler supports 1 category (FormGenerator) and 2+ categories (CompositeFormGenerator), returns JSON with form name and FormEdit URL.</done>
</task>

<task type="auto">
  <name>Task 2: Register Special page, JS module, i18n messages</name>
  <files>extension.json, SemanticSchemas.alias.php, i18n/en.json, i18n/qqq.json</files>
  <action>
**extension.json changes:**

1. Add to `SpecialPages`:
   ```json
   "CreateSemanticPage": "MediaWiki\\Extension\\SemanticSchemas\\Special\\SpecialCreateSemanticPage"
   ```

2. Add new ResourceModule `ext.semanticschemas.createpage`:
   ```json
   "ext.semanticschemas.createpage": {
     "scripts": ["resources/ext.semanticschemas.createpage.js"],
     "styles": ["resources/ext.semanticschemas.createpage.css"],
     "dependencies": [
       "mediawiki.api",
       "mediawiki.util",
       "mediawiki.Title",
       "jquery"
     ],
     "messages": [
       "semanticschemas-createpage-empty-state",
       "semanticschemas-createpage-loading",
       "semanticschemas-createpage-error",
       "semanticschemas-createpage-shared-section",
       "semanticschemas-createpage-required",
       "semanticschemas-createpage-optional",
       "semanticschemas-createpage-remove-category",
       "semanticschemas-createpage-namespace-conflict",
       "semanticschemas-createpage-namespace-label",
       "semanticschemas-createpage-page-exists-warning",
       "semanticschemas-createpage-submit",
       "semanticschemas-createpage-submitting",
       "semanticschemas-createpage-submit-error",
       "semanticschemas-createpage-no-categories",
       "semanticschemas-createpage-no-pagename"
     ],
     "localBasePath": "",
     "remoteExtPath": "SemanticSchemas",
     "targets": ["desktop", "mobile"]
   }
   ```

**SemanticSchemas.alias.php changes:**

Add alias for the new special page:
```php
$specialPageAliases['en'] = [
    'SemanticSchemas' => [ 'SemanticSchemas', 'Semantic Schemas' ],
    'CreateSemanticPage' => [ 'CreateSemanticPage', 'Create Semantic Page' ],
];
```

**i18n/en.json changes:**

Add these message keys (insert alphabetically near existing createpage messages or after the last semanticschemas- entry):
```json
"semanticschemas-createpage-title": "Create Semantic Page",
"semanticschemas-createpage-tree-title": "Select Categories",
"semanticschemas-createpage-preview-title": "Property Preview",
"semanticschemas-createpage-empty-state": "Select categories from the tree to preview properties.",
"semanticschemas-createpage-loading": "Loading properties...",
"semanticschemas-createpage-error": "Failed to load property data: $1",
"semanticschemas-createpage-shared-section": "Shared Properties",
"semanticschemas-createpage-required": "required",
"semanticschemas-createpage-optional": "optional",
"semanticschemas-createpage-remove-category": "Remove category",
"semanticschemas-createpage-namespace-conflict": "Selected categories target different namespaces. Choose where to create the page:",
"semanticschemas-createpage-namespace-label": "Namespace: $1 (used by: $2)",
"semanticschemas-createpage-pagename-label": "Page name",
"semanticschemas-createpage-pagename-placeholder": "Enter page name",
"semanticschemas-createpage-page-exists-warning": "A page with this name already exists. Submitting will open it for editing.",
"semanticschemas-createpage-submit": "Create Page",
"semanticschemas-createpage-submitting": "Creating...",
"semanticschemas-createpage-submit-error": "Failed to create page: $1",
"semanticschemas-createpage-no-categories": "Select at least one category.",
"semanticschemas-createpage-no-pagename": "Enter a page name."
```

**i18n/qqq.json changes:**

Add documentation for each new message key:
```json
"semanticschemas-createpage-title": "Title for the Create Semantic Page special page",
"semanticschemas-createpage-tree-title": "Heading for the category selection tree panel",
"semanticschemas-createpage-preview-title": "Heading for the property preview panel",
"semanticschemas-createpage-empty-state": "Instructional text shown when no categories are selected",
"semanticschemas-createpage-loading": "Loading indicator text while fetching properties",
"semanticschemas-createpage-error": "Error message when API call fails. $1 is the error detail",
"semanticschemas-createpage-shared-section": "Section heading for properties shared across multiple categories",
"semanticschemas-createpage-required": "Label for required properties",
"semanticschemas-createpage-optional": "Label for optional properties",
"semanticschemas-createpage-remove-category": "Aria label for the remove button on category chips",
"semanticschemas-createpage-namespace-conflict": "Message shown when selected categories have conflicting target namespaces",
"semanticschemas-createpage-namespace-label": "Label for namespace radio option. $1 is namespace name, $2 is comma-separated category names",
"semanticschemas-createpage-pagename-label": "Label for the page name input field",
"semanticschemas-createpage-pagename-placeholder": "Placeholder text for page name input",
"semanticschemas-createpage-page-exists-warning": "Warning shown when the entered page name already exists",
"semanticschemas-createpage-submit": "Text on the submit button",
"semanticschemas-createpage-submitting": "Text on submit button while form is being submitted",
"semanticschemas-createpage-submit-error": "Error message when form submission fails. $1 is the error detail",
"semanticschemas-createpage-no-categories": "Validation message when no categories selected",
"semanticschemas-createpage-no-pagename": "Validation message when page name is empty"
```
  </action>
  <verify>
Run `composer test` -- all checks pass.
Verify `extension.json` is valid JSON (no trailing commas, proper structure).
Verify new special page alias does not conflict with existing aliases.
Verify ResourceModule messages array includes all 15 message keys (including `semanticschemas-createpage-no-categories` and `semanticschemas-createpage-no-pagename`).
  </verify>
  <done>Special page registered in extension.json SpecialPages. ResourceModule registered with script/style/dependencies/messages (15 messages including no-categories and no-pagename). Alias file updated. All i18n messages defined in en.json and documented in qqq.json.</done>
</task>

</tasks>

<verification>
1. `composer test` passes (phpcs, parallel-lint, minus-x, phpunit)
2. `extension.json` is valid JSON with new SpecialPage and ResourceModule entries
3. PHP class follows PSR-4 autoloading and MediaWiki SpecialPage conventions
4. renderLayout() embeds root category as `data-root-category` attribute
5. POST handler supports 1 category (FormGenerator) and 2+ categories (CompositeFormGenerator)
6. All i18n messages defined and documented
7. ResourceModule messages array includes all 15 keys
</verification>

<success_criteria>
- Special:CreateSemanticPage is accessible (registered in extension.json)
- Permission check requires 'edit' right
- HTML skeleton renders with all container IDs for JS, including data-root-category
- POST action supports 1+ categories and returns JSON with formName and formEditUrl
- JS module and CSS registered in ResourceLoader with all 15 message keys
- All i18n messages in en.json and qqq.json
</success_criteria>

<output>
After completion, create `.planning/phases/08-create-page-ui/08-02-SUMMARY.md`
</output>
