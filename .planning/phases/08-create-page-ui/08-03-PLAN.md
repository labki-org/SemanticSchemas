---
phase: 08-create-page-ui
plan: 03
type: execute
wave: 2
depends_on: ["08-01", "08-02"]
files_modified:
  - resources/ext.semanticschemas.createpage.js
  - resources/ext.semanticschemas.createpage.css
autonomous: false

must_haves:
  truths:
    - "Collapsible hierarchy tree displays all categories with checkboxes"
    - "Checking/unchecking categories triggers AJAX preview showing merged/deduplicated properties"
    - "Each property in preview shows name, datatype, and required/optional status"
    - "Selected categories appear as removable chips outside the tree"
    - "Page name input field allows naming the new page"
    - "Submit button disabled until category selected and page name entered"
    - "Submitting generates composite form and redirects to Special:FormEdit"
    - "Namespace conflict picker appears when categories target different namespaces"
  artifacts:
    - path: "resources/ext.semanticschemas.createpage.js"
      provides: "Client-side UI: tree, preview, chips, namespace picker, submit"
      min_lines: 200
    - path: "resources/ext.semanticschemas.createpage.css"
      provides: "Styles matching the existing design system"
      min_lines: 50
  key_links:
    - from: "resources/ext.semanticschemas.createpage.js"
      to: "api.php?action=semanticschemas-hierarchy"
      via: "AJAX call for tree data"
      pattern: "semanticschemas-hierarchy"
    - from: "resources/ext.semanticschemas.createpage.js"
      to: "api.php?action=semanticschemas-multicategory"
      via: "AJAX call for property preview"
      pattern: "semanticschemas-multicategory"
    - from: "resources/ext.semanticschemas.createpage.js"
      to: "Special:CreateSemanticPage POST handler"
      via: "Form submission for composite form generation"
      pattern: "action.*createpage|postWithEditToken"
---

<objective>
Build the client-side JavaScript module and CSS for the Create Page UI -- hierarchy tree with checkboxes, live property preview, chip list, namespace picker, page name input, and submit-to-FormEdit flow.

Purpose: This is the user-facing interactive layer. Users select categories from the tree, see merged/deduplicated properties in real-time, name their page, and submit to be redirected to FormEdit with the composite form ready. This plan wires together the hierarchy API (tree data), multi-category API (property preview), and the SpecialPage POST handler (form generation).

Output: Working interactive UI at Special:CreateSemanticPage with all CONTEXT.md decisions implemented.
</objective>

<execution_context>
@/home/daharoni/.claude/get-shit-done/workflows/execute-plan.md
@/home/daharoni/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-create-page-ui/08-CONTEXT.md
@.planning/phases/08-create-page-ui/08-RESEARCH.md
@.planning/phases/08-create-page-ui/08-01-SUMMARY.md
@.planning/phases/08-create-page-ui/08-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create JavaScript module (ext.semanticschemas.createpage.js)</name>
  <files>resources/ext.semanticschemas.createpage.js</files>
  <action>
CONTEXT BUDGET NOTE: This task covers 6 UI components in a single JS file. Build them in order below, keeping implementations concise and following existing hierarchy.js patterns closely. If context is getting tight past the preview component, prioritize getting all components functional over polish -- the human-verify checkpoint will catch issues.

Create `resources/ext.semanticschemas.createpage.js` as an IIFE following the exact pattern from `ext.semanticschemas.hierarchy.js`.

**Module structure:**

```javascript
(function (mw, $) {
    'use strict';
    // Constants, state, helpers, components, init
}(mediaWiki, jQuery));
```

**Constants and state:**

```javascript
var UPDATE_DELAY = 300; // ms debounce for property preview
var PAGE_CHECK_DELAY = 500; // ms debounce for page existence check
var updateTimer = null;
var pageCheckTimer = null;
var requestCounter = 0; // Race condition prevention
var selectedCategories = {}; // { categoryName: true }
var currentNamespace = null; // Selected namespace (null = default)
var treeData = null; // Cached hierarchy data
```

**Helpers** -- reuse patterns from hierarchy.js:
- `var msg = function (name) { return mw.msg(name); };`
- `var stripPrefix = function (title, prefix) { ... };` (same as hierarchy.js)

**Component 1: Tree loading and rendering**

On init, read the root category from `$('#ss-createpage-tree').data('root-category')`. Plan 02 guarantees this data attribute is embedded by the PHP renderLayout() method. Call `semanticschemas-hierarchy` API with this root category to get tree data.

Build the tree recursively from `data.nodes`, following hierarchy.js `buildNode` but adding checkboxes:
- Each node gets: toggle arrow (if has children), checkbox input (`<input type="checkbox" data-category="CategoryName">`), category display name
- First level expanded (depth === 0 children visible), deeper levels collapsed (CONTEXT.md decision)
- Toggle behavior: click arrow to expand/collapse children (same slideUp/slideDown pattern as hierarchy.js)
- No auto-select of children when parent checked (CONTEXT.md locked decision)
- IMPORTANT: In the hierarchy API, `node.parents` contains CHILD categories (categories that inherit from this node), not parent categories. This is the SemanticSchemas convention documented in RESEARCH.md Pitfall 2.

Checkbox change handler:
- Update `selectedCategories` map
- Call `onSelectionChanged()` (debounced)
- Update chip list

**Component 2: Chip list**

Render selected categories as removable chips in `#ss-createpage-chips`:
- Each chip: `<span class="ss-createpage-chip">` with label text and X remove button
- Remove button: unchecks the corresponding tree checkbox, removes from `selectedCategories`, calls `onSelectionChanged()`
- Sync: when checkbox changes in tree, update chips; when chip removed, update tree checkbox

**Component 3: Property preview (debounced AJAX)**

`onSelectionChanged()`:
1. Clear debounce timer, set new one with UPDATE_DELAY (300ms)
2. Get list of selected category names from `selectedCategories`
3. If empty: show empty state message in `#ss-createpage-preview`, hide namespace picker, update submit button state
4. If non-empty: call `fetchPreview(categories)`

`fetchPreview(categories)`:
1. Increment `requestCounter` (local variable `thisRequest = ++requestCounter`)
2. Show loading state: add `ss-hierarchy-loading` class to preview, set loading text
3. Call `new mw.Api().get({ action: 'semanticschemas-multicategory', categories: categories.join('|') })`
4. On success: check `thisRequest === requestCounter` (discard stale responses, RESEARCH.md Pitfall 4)
5. Remove loading state
6. Call `renderPropertyPreview(data)` and `checkNamespaceConflict(data)`
7. On failure: show inline error in preview area (RESEARCH.md discretion recommendation)

`renderPropertyPreview(data)`:
- Group properties: "Shared" section at top (properties where `shared === 1`), then per-category sections
- Shared section: heading uses `msg('semanticschemas-createpage-shared-section')`, light accent-50 background
- Per-category sections: heading is category name
- Each property row shows:
  - Property name (bold)
  - Datatype badge (small, muted -- from the new `datatype` field in API response)
  - Required/optional badge (use existing `ss-prop-required` / `ss-prop-optional` + `ss-prop-badge` CSS classes from hierarchy.css)
- Use the existing grid layout pattern from hierarchy.css (`ss-prop-list-by-type` class)

**Component 4: Namespace conflict detection and picker**

`checkNamespaceConflict(data)`:
1. Extract `targetNamespace` from each category in `data.categories` (now objects with `name` and `targetNamespace`)
2. Collect unique non-null namespaces. Treat null as "Main" (NS_MAIN)
3. If 0 or 1 unique namespace: hide `#ss-createpage-namespace`, set `currentNamespace` to the single value (or null)
4. If 2+ unique namespaces: show namespace picker in `#ss-createpage-namespace`

Namespace picker (when conflict):
- Instructional text: `msg('semanticschemas-createpage-namespace-conflict')`
- Radio buttons for each unique namespace
- Each radio label: namespace name + which categories use it (e.g., "Main (used by: Person)" or "Staff (used by: Employee)")
- Display "Main" for null namespace
- On radio change: update `currentNamespace`
- Default: pre-select the first radio option

**Component 5: Page name input with existence check**

- Listen to `input` event on `#ss-createpage-pagename` with debounce (PAGE_CHECK_DELAY = 500ms)
- On input change (debounced): check if page exists using `mw.Api().get({ action: 'query', titles: fullTitle })`
  - Build `fullTitle`: if `currentNamespace`, prepend `currentNamespace + ':'` to page name
  - Check response: if page has no `missing` property, it exists
  - Show warning in `#ss-createpage-page-warning`: `msg('semanticschemas-createpage-page-exists-warning')` -- warn but allow (RESEARCH.md discretion)
  - If page doesn't exist: hide warning
- Update submit button state on every input change

**Component 6: Submit button (progressive disclosure)**

`updateSubmitState()`:
- Enable submit button ONLY when: `Object.keys(selectedCategories).length > 0 AND pageName.trim() !== ''`
- Called after: category selection changes, page name input changes

Submit handler (`#ss-createpage-submit` click):
1. Prevent if disabled
2. Disable button, show "Creating..." text (`msg('semanticschemas-createpage-submitting')`)
3. Gather data: categories (array), pagename, namespace (from currentNamespace)
4. POST to current page URL with:
   - `action=createpage`
   - `categories[]` = each selected category
   - `pagename` = page name value
   - `namespace` = currentNamespace (if set)
   - Include CSRF token via `mw.Api().postWithEditToken()` or manually with `mw.user.tokens.get('csrfToken')`

   IMPORTANT: This is a POST to the SpecialPage, NOT to the API. Use jQuery `$.post()` to the special page URL, including the edit token as `wpEditToken`.

   ```javascript
   $.post(mw.util.getUrl('Special:CreateSemanticPage'), {
       action: 'createpage',
       categories: Object.keys(selectedCategories),
       pagename: pageName,
       namespace: currentNamespace || '',
       wpEditToken: mw.user.tokens.get('csrfToken')
   }, 'json')
   ```

5. On success response (`response.success === true`):
   - Redirect: `window.location.href = mw.util.getUrl('Special:FormEdit/' + response.formName + '/' + targetPage)`
   - Where `targetPage` = namespace ? namespace + ':' + pageName : pageName
   - OR use `response.formEditUrl` if the server provides a pre-built URL
6. On error: re-enable button, show inline error in preview area, restore button text

**Init function:**
1. Read root category from `$('#ss-createpage-tree').data('root-category')` (guaranteed by Plan 02)
2. Fetch hierarchy tree data via `semanticschemas-hierarchy` API
3. Build checkbox tree
4. Attach event handlers (checkbox change, chip remove, page name input, submit)
5. Set initial state (empty preview, submit disabled)

Call init on DOM ready: `$(function () { init(); });`

CRITICAL ANTI-PATTERNS FROM CONTEXT.MD (locked decisions -- do NOT violate):
- No auto-select of children when parent checked
- No search/filter input on the tree
- Tree starts with first level expanded, deeper collapsed
- Live update with debounce, no manual "Preview" button
- Submit redirects straight to FormEdit, no confirmation
  </action>
  <verify>
Run `composer test` -- linting passes (minus-x check for JS).
Manually verify the JS file:
- Uses IIFE pattern `(function (mw, $) { ... }(mediaWiki, jQuery));`
- All user-facing strings use `mw.msg()` (no hardcoded English)
- Debounce used for API calls
- Request counter used for race condition prevention
- Submit button disabled until selection + page name
  </verify>
  <done>JavaScript module implements: hierarchy tree with checkboxes, chip list, debounced AJAX property preview with shared/per-category grouping and datatype display, namespace conflict picker with radio buttons, page name input with existence warning, submit flow that POSTs to SpecialPage and redirects to FormEdit.</done>
</task>

<task type="auto">
  <name>Task 2: Create CSS styles (ext.semanticschemas.createpage.css)</name>
  <files>resources/ext.semanticschemas.createpage.css</files>
  <action>
Create `resources/ext.semanticschemas.createpage.css` using the existing design system (--ss-* CSS custom properties from `ext.semanticschemas.styles.css`). Follow patterns from `ext.semanticschemas.hierarchy.css`.

**Layout:**

```css
/* Two-panel layout: tree on left, preview on right */
.ss-createpage-layout {
    display: grid;
    grid-template-columns: 1fr 2fr;
    gap: var(--ss-space-6, 24px);
    align-items: start;
}
```

**Tree panel:**
- `.ss-createpage-tree-panel`: border, border-radius, padding matching `ss-hierarchy-special-form` pattern
- Reuse existing tree styles from hierarchy.css (the tree container will use `ss-hierarchy-tree` and `ss-hierarchy-tree-nested` classes)
- Checkbox styling: `.ss-createpage-checkbox` -- align with tree node text, use accent color for checked state
- Max-height with overflow-y scroll for long trees (e.g., `max-height: 60vh; overflow-y: auto;`)

**Chip list:**
```css
.ss-createpage-chips {
    display: flex;
    flex-wrap: wrap;
    gap: var(--ss-space-2, 8px);
    margin-bottom: var(--ss-space-4, 16px);
    min-height: 2rem; /* Reserve space even when empty */
}

.ss-createpage-chip {
    display: inline-flex;
    align-items: center;
    gap: var(--ss-space-1, 4px);
    padding: var(--ss-space-1, 4px) var(--ss-space-3, 12px);
    background: var(--ss-accent-50, #ecfeff);
    border: 1px solid var(--ss-accent-100, #d5f5f6);
    border-radius: 999px;
    font-size: 0.8125rem;
    color: var(--ss-accent-600, #0d7377);
}

.ss-createpage-chip-remove {
    /* Small X button */
    background: none;
    border: none;
    cursor: pointer;
    color: var(--ss-accent-600, #0d7377);
    font-size: 0.875rem;
    padding: 0 2px;
    line-height: 1;
    opacity: 0.7;
}
.ss-createpage-chip-remove:hover {
    opacity: 1;
    color: var(--ss-error-600, #dc2626);
}
```

**Preview panel:**
- `.ss-createpage-preview-panel`: border, background matching existing panel patterns
- Preview area reuses existing property list styles from hierarchy.css
- Shared properties section: light accent background (`var(--ss-accent-50)`)

**Shared section header:**
```css
.ss-createpage-shared-section {
    background: var(--ss-accent-50, #ecfeff);
    border: 1px solid var(--ss-accent-100, #d5f5f6);
    border-radius: var(--ss-radius-md, 10px);
    padding: var(--ss-space-4, 16px);
    margin-bottom: var(--ss-space-4, 16px);
}
```

**Datatype badge:**
```css
.ss-createpage-datatype {
    display: inline-block;
    font-size: 0.6875rem;
    font-weight: 500;
    padding: 0.0625rem 0.375rem;
    margin-left: var(--ss-space-2, 8px);
    border-radius: var(--ss-radius-sm, 6px);
    background: var(--ss-slate-100, #f1f5f9);
    color: var(--ss-slate-600, #475569);
}
```

**Namespace picker:**
```css
.ss-createpage-namespace-picker {
    margin: var(--ss-space-4, 16px) 0;
    padding: var(--ss-space-4, 16px);
    background: var(--ss-warning-50, #fefce8);
    border: 1px solid var(--ss-warning-100, #fef9c3);
    border-left: 4px solid var(--ss-warning-600, #ca8a04);
    border-radius: var(--ss-radius-md, 10px);
}
```

**Submit area:**
```css
.ss-createpage-submit-area {
    margin-top: var(--ss-space-6, 24px);
    padding-top: var(--ss-space-6, 24px);
    border-top: 1px solid var(--ss-slate-200, #e2e8f0);
}
/* Page name input: reuse ss-hierarchy-special-form input styles */
#ss-createpage-pagename {
    width: 100%;
    max-width: 400px;
    padding: 0.5rem 0.75rem;
    border: 1px solid var(--ss-slate-300, #cbd5e1);
    border-radius: var(--ss-radius-sm, 6px);
    font-size: 0.9375rem;
    color: var(--ss-slate-800, #1e242f);
    margin-bottom: var(--ss-space-3, 12px);
}
#ss-createpage-pagename:focus {
    outline: none;
    border-color: var(--ss-accent-500, #0f9099);
    box-shadow: 0 0 0 3px var(--ss-accent-100, #d5f5f6);
}
```

**Page exists warning:**
```css
.ss-createpage-page-warning {
    padding: var(--ss-space-2, 8px) var(--ss-space-3, 12px);
    margin-bottom: var(--ss-space-3, 12px);
    background: var(--ss-warning-50, #fefce8);
    border: 1px solid var(--ss-warning-100, #fef9c3);
    border-radius: var(--ss-radius-sm, 6px);
    color: var(--ss-warning-600, #ca8a04);
    font-size: 0.8125rem;
}
```

**Submit button:**
```css
/* Primary action button -- matches existing extension button pattern if one exists, otherwise use accent */
.ss-btn-primary {
    padding: 0.5rem 1.5rem;
    background: var(--ss-accent-600, #0d7377);
    color: #fff;
    border: none;
    border-radius: var(--ss-radius-sm, 6px);
    font-size: 0.9375rem;
    font-weight: 600;
    cursor: pointer;
    transition: background-color 0.15s ease, opacity 0.15s ease;
}
.ss-btn-primary:hover:not(:disabled) {
    background: var(--ss-accent-500, #0f9099);
}
.ss-btn-primary:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}
```

**Loading state:** Reuse `ss-hierarchy-loading` class from hierarchy.css (opacity 0.5, pointer-events none).

**Responsive (mobile):**
```css
@media (max-width: 768px) {
    .ss-createpage-layout {
        grid-template-columns: 1fr;
    }
}
```
  </action>
  <verify>
Run `composer test` -- linting passes.
Verify CSS uses `var(--ss-*)` design tokens throughout (no hardcoded colors except in fallbacks).
Verify responsive breakpoint exists.
  </verify>
  <done>CSS styles created with two-panel grid layout, chip styling, shared section highlight, datatype badges, namespace conflict warning, page name input, submit button, loading states, and responsive breakpoint. All using existing design system tokens.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete Create Page UI: Special:CreateSemanticPage with hierarchy tree selection, live property preview (showing name, datatype, required/optional), chip list, namespace conflict picker, page name input, and submit-to-FormEdit flow.</what-built>
  <how-to-verify>
1. Start the Docker test environment if not running: `bash tests/scripts/reinstall_test_env.sh` then `bash tests/scripts/populate_test_data.sh`
2. Visit http://localhost:8889/wiki/Special:CreateSemanticPage (logged in as Admin/dockerpass)
3. Verify the hierarchy tree loads and displays categories with checkboxes
4. Check a single category -- verify:
   a. A chip appears above the preview
   b. Property preview updates showing property names, datatypes, and required/optional badges
5. Check a second category -- verify:
   a. Shared properties appear in a "Shared Properties" section at top
   b. Category-specific properties appear in per-category sections
6. Uncheck a category via the chip X button -- verify tree checkbox also unchecks
7. Type a page name -- verify submit button enables
8. If test data has categories with different targetNamespace, verify namespace picker appears
9. Click submit with a single category selected -- verify redirect to Special:FormEdit with the standard form
10. Click submit with multiple categories selected -- verify redirect to Special:FormEdit with the composite form
11. Test edge cases: no categories selected (empty state shown), rapid checking/unchecking (no stale previews)
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues with the UI behavior, layout, or flow.</resume-signal>
</task>

</tasks>

<verification>
1. `composer test` passes
2. JS module loads without console errors
3. Tree renders from hierarchy API data using root category from data attribute
4. Property preview updates on category selection with correct shared/specific grouping
5. Chip list syncs with tree checkboxes bidirectionally
6. Namespace picker appears only on namespace conflict
7. Submit generates form server-side and redirects to FormEdit (works for both 1 and 2+ categories)
8. All text uses i18n messages (no hardcoded English)
</verification>

<success_criteria>
- Full interactive flow works: select categories -> preview properties -> name page -> submit -> FormEdit
- Single-category flow works: select 1 category -> preview -> name -> submit -> FormEdit with standard form
- All CONTEXT.md locked decisions honored (no auto-select, no search, first level expanded, live debounced preview, direct FormEdit redirect)
- Design matches existing SemanticSchemas design system (--ss-* tokens, slate palette, accent teal)
- No console errors, no race conditions on rapid selection
</success_criteria>

<output>
After completion, create `.planning/phases/08-create-page-ui/08-03-SUMMARY.md`
</output>
